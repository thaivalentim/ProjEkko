<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico Chat EKKO</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #00ff00; }
        .ok { color: #00ff00; }
        .erro { color: #ff0000; }
        .info { color: #ffff00; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        pre { background: #000; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico Chat EKKO</h1>
    
    <h2>1. Unity ID</h2>
    <div id="unity-id"></div>
    
    <h2>2. Chaves no localStorage</h2>
    <div id="storage-keys"></div>
    
    <h2>3. Sess√µes Carregadas</h2>
    <div id="sessions"></div>
    
    <h2>4. A√ß√µes</h2>
    <button onclick="limparTudo()">Limpar TUDO</button>
    <button onclick="criarSessaoTeste()">Criar Sess√£o Teste</button>
    <button onclick="location.reload()">Recarregar</button>
    
    <h2>5. Console</h2>
    <pre id="console"></pre>

    <script>
        const log = (msg, tipo = 'info') => {
            const consoleDiv = document.getElementById('console');
            const span = document.createElement('span');
            span.className = tipo;
            span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            consoleDiv.appendChild(span);
            console.log(msg);
        };

        // 1. Verificar Unity ID
        const unityId = localStorage.getItem('unityId');
        const unityDiv = document.getElementById('unity-id');
        if (unityId) {
            unityDiv.innerHTML = `<span class="ok">‚úì Unity ID: ${unityId}</span>`;
            log(`Unity ID encontrado: ${unityId}`, 'ok');
        } else {
            unityDiv.innerHTML = `<span class="erro">‚úó Unity ID n√£o encontrado!</span>`;
            log('ERRO: Unity ID n√£o encontrado', 'erro');
        }

        // 2. Listar chaves
        const keysDiv = document.getElementById('storage-keys');
        const allKeys = Object.keys(localStorage).filter(k => k.includes('ekko'));
        if (allKeys.length > 0) {
            keysDiv.innerHTML = '<span class="ok">‚úì Chaves encontradas:</span><ul>' + 
                allKeys.map(k => `<li>${k}</li>`).join('') + '</ul>';
            log(`${allKeys.length} chaves encontradas`, 'ok');
        } else {
            keysDiv.innerHTML = '<span class="info">‚ö† Nenhuma chave encontrada</span>';
            log('Nenhuma chave encontrada', 'info');
        }

        // 3. Verificar sess√µes
        const sessionsDiv = document.getElementById('sessions');
        if (unityId) {
            const storageKey = `ekkoChatSessions_${unityId}`;
            const sessionsData = localStorage.getItem(storageKey);
            
            if (sessionsData) {
                try {
                    const sessions = JSON.parse(sessionsData);
                    const count = Object.keys(sessions).length;
                    sessionsDiv.innerHTML = `<span class="ok">‚úì ${count} sess√µes encontradas</span>`;
                    log(`${count} sess√µes carregadas`, 'ok');
                } catch (e) {
                    sessionsDiv.innerHTML = `<span class="erro">‚úó Erro ao parsear sess√µes: ${e.message}</span>`;
                    log(`ERRO ao parsear: ${e.message}`, 'erro');
                }
            } else {
                sessionsDiv.innerHTML = '<span class="info">‚ö† Nenhuma sess√£o salva</span>';
                log('Nenhuma sess√£o salva', 'info');
            }
        }

        function limparTudo() {
            if (confirm('Limpar TODAS as conversas de TODOS os usu√°rios?')) {
                Object.keys(localStorage)
                    .filter(k => k.includes('ekko'))
                    .forEach(k => {
                        localStorage.removeItem(k);
                        log(`Removido: ${k}`, 'info');
                    });
                alert('Tudo limpo!');
                location.reload();
            }
        }

        function criarSessaoTeste() {
            if (!unityId) {
                alert('Unity ID n√£o encontrado!');
                return;
            }
            
            const storageKey = `ekkoChatSessions_${unityId}`;
            const activeKey = `ekkoActiveSessionId_${unityId}`;
            
            const sessionId = `session_${Date.now()}`;
            const sessions = {
                [sessionId]: {
                    title: 'Teste',
                    history: '<div class="message bot-message">Teste OK!</div>'
                }
            };
            
            localStorage.setItem(storageKey, JSON.stringify(sessions));
            localStorage.setItem(activeKey, sessionId);
            
            log('Sess√£o teste criada!', 'ok');
            alert('Sess√£o teste criada! Recarregue a p√°gina.');
        }

        log('Diagn√≥stico completo', 'ok');
    </script>
</body>
</html>
